#!/bin/bash

_debug() {

  local readonly msg="$1"

  echo "."
  echo "bodega >> [Debug] << ${msg}"
  echo "."
}


_error() {

  local readonly msg="$1"

  echo "."
  echo "."
  echo "bodega >> [Error] << ${msg}"
  echo "."
  echo "."

  return 1
}


_error_fatal() {

  local readonly msg="$1"

  echo "."
  echo "."
  echo "bodega >> [Fatal Error] << ${msg}"
  echo "."
  echo "."

  exit 1
}


_os_check() {

  . /etc/os-release

  [[ ${1,,} =~ ${ID}${ID:+|}${ID_LIKE// /|} ]] \
    && [[ ${VERSION_ID} =~ ${2,,} ]]           \
    && [[ ${CPE_NAME}   =~ ${3,,} ]]           \
    && return 0

  return 1
}


_stash_outset_vars() {

  local outset_vars

  read outset_vars <<< $(
    set 2>/dev/null | while read a
      do [[ $a == *=* ]] || break
        echo ${a/=*}
      done
  )

  BODEGA_OUTSET_VARS="${outset_vars}"
}


_setup_ubuntu() {

  sudo -- apt-get update
  sudo -- apt-get install cmake
}


_setup_macos() {

  brew install cmake
}


_yield_cmake_defs_default() {

  echo
}


_yield_cmake_defaults_typeA() {

  local cmake_definitions
  local item

  while read item; do
    cmake_definitions="${cmake_definitions}${item:+ -D${item}}"
  done < <( cat <<-__EOF__

    CMAKE_BUILD_TYPE=Release
    CMAKE_Fortran_COMPILER=/usr/local/opt/gfortran/bin/gfortran

	__EOF__
  )

  BODEGA_CMAKE_DEFINITIONS="${cmake_definitions}"
}


_yield_cmake_defs() {

  local outsetvars
  local postvars

  read outsetvars <<< $(
    set 2>/dev/null | while read a
      do [[ $a == *=* ]] || break
        echo ${a/=*}
      done
  )

  CMAKE_BUILD_TYPE=Release
  CMAKE_Fortran_COMPILER=/usr/local/opt/gfortran/bin/gfortran

  read postvars <<< $(
    set 2>/dev/null | while read a
      do [[ $a == *=* ]] || break
        echo ${a/=*}
      done
  )

  # find the symmetric difference of the two var sets and save these under a global var
  read BODEGA_CMAKE_DEFINITION_VARS <<< $(
  	echo ${outsetvars} ${postvars} | tr ' ' '\n' | sort | uniq -u | tr '\n' ' '
  )
}


_cmake_intel() {

  echo
}


_cmake_mpiwrapper() {

  echo
}


_render_cmake_args() {

  env | grep "CMAKE_"
}


_cmake_ordinary() {

  mkdir -p ./build && cd $_
  cmake .. && make
}


__bodega_build() {

  #_stash_outset_vars
  #_yield_cmake_defs
  _cmake_ordinary
}


__bodega_test() {

  echo
}


BODEGA_OUTSET_VARS=''
BODEGA_CMAKE_DEFINITION_VARS=''

[[ -n "$1" ]] && "__bodega_$1" "$@"

echo $BODEGA_CMAKE_DEFINITION_VARS


#source ./cmake_definitions


#-DCMAKE_BUILD_TYPE=Debug
#-DCMAKE_BUILD_TYPE=Release

