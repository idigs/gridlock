#!/bin/bash

_debug() {

  local readonly msg="$1"

  echo "."
  echo "bodega >> [Debug] << ${msg}"
  echo "."
}


_error() {

  local readonly msg="$1"

  echo "."
  echo "."
  echo "bodega >> [Error] << ${msg}"
  echo "."
  echo "."

  return 1
}


_error_fatal() {

  local readonly msg="$1"

  echo "."
  echo "."
  echo "bodega >> [Fatal Error] << ${msg}"
  echo "."
  echo "."

  exit 1
}


_os_check() {

  . /etc/os-release

  [[ ${1,,} =~ ${ID}${ID:+|}${ID_LIKE// /|} ]] \
    && [[ ${VERSION_ID} =~ ${2,,} ]]           \
    && [[ ${CPE_NAME}   =~ ${3,,} ]]           \
    && return 0

  return 1
}


_denote_outset_vars() {

  local outset_vars

  read outset_vars <<< $(
    set 2>/dev/null | while read a
      do [[ $a == *=* ]] || break
        echo ${a/=*}
      done
  )

  BODEGA_OUTSET_VARS="${outset_vars}"
}


_accrue_cmake_definitions() {

  local current_vars
  local latest_vars
  local cmake_vars

  read current_vars <<< $(
    set 2>/dev/null | while read a
      do [[ $a == *=* ]] || break
        echo ${a/=*}
      done
  )

  # find the symmetric difference of the two var sets (outset and current)
  read latest_vars <<< $(
    echo $BODEGA_OUTSET_VARS ${current_vars} | tr ' ' '\n' | sort | uniq -u | tr '\n' ' '
  )

  # isolate new vars that serve as cmake definitions
  read cmake_vars <<< $(
    echo ${latest_vars} | tr ' ' '\n' | grep "^CMAKE_*" | tr '\n' ' '
  )

  BODEGA_CMAKE_DEFINITION_VARS="${cmake_vars}"
}


_setup_ubuntu() {

  sudo -- apt-get update
  sudo -- apt-get install cmake
}


_setup_macos() {

  brew install cmake
}


_setup_nersc_cori() {

  module load cmake
}


_yield_cmake_defaults_typeA() {

  local cmake_definitions
  local item

  while read item; do
    cmake_definitions="${cmake_definitions}${item:+ -D${item}}"
  done < <( cat <<-__EOF__

    CMAKE_BUILD_TYPE=Release
    CMAKE_Fortran_COMPILER=/usr/local/opt/gfortran/bin/gfortran

	__EOF__
  )

  BODEGA_CMAKE_DEFINITIONS="${cmake_definitions}"
}


_yield_cmake_oneoff() {

  CMAKE_PREFIX_PATH="/opt/usr/lib"
}


_yield_defaults_cmake() {

  CMAKE_BUILD_TYPE=Release
  CMAKE_Fortran_COMPILER=/usr/local/opt/gfortran/bin/gfortran
  CMAKE_PREFIX_PATH="${some_othervar}:/usr/local/lib"
}


_cmake_macos_github() {

  CMAKE_Fortran_COMPILER=/usr/local/opt/gfortran/bin/gfortran
}


_cmake_mpiwrapper() {

  CMAKE_C_COMPILER=/opt/intel/compilers_and_libraries_2019.3.199/linux/bin/intel64/ifort
  echo module load openmpi
}


_render_cmake_args() {

  echo #BODEGA_CMAKE_DEFINITION_VARS | while read a;
}


_cmake_ordinary() {

  mkdir -p ./build && cd $_
  cmake .. && make
}

# ./build/cmake_profile_nersc

#  CMAKE_BUILD_TYPE=Release
#  CMAKE_Fortran_COMPILER=/usr/local/opt/gfortran/bin/gfortran
#  CMAKE_PREFIX_PATH="${some_othervar}:/usr/local/lib"


__bodega_build() {

  #_denote_outset_vars
  #_yield_defaults_cmake
  #_accrue_cmake_definitions


  _cmake_ordinary

  # differentiate by:
    # - compute_env:   [ nersc github ]
    # - os_type:       [ ubuntu macos ]
    # - mpi_wrapper:   [ openmpi mpich intel ]
    # - 


}


__bodega_test() {

  echo
}


BODEGA_OUTSET_VARS=''
BODEGA_CMAKE_DEFINITION_VARS=''

[[ -n "$1" ]] && "__bodega_$1" "$@"

echo $BODEGA_CMAKE_DEFINITION_VARS


#source ./cmake_definitions


#-DCMAKE_BUILD_TYPE=Debug
#-DCMAKE_BUILD_TYPE=Release

